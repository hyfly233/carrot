# Carrot YARN 项目调试指南

## 目录

1. [开发环境调试](#开发环境调试)
2. [使用 Delve 调试器](#使用-delve-调试器)
3. [日志调试](#日志调试)
4. [单元测试调试](#单元测试调试)
5. [集成测试调试](#集成测试调试)
6. [性能调试](#性能调试)
7. [网络调试](#网络调试)
8. [常见问题排查](#常见问题排查)

## 开发环境调试

### 1. IDE 调试配置

#### VS Code 配置

创建 `.vscode/launch.json` 配置文件：

```json
{
    "version": "0.2.0",
    "configurations": [
        {
            "name": "Debug ResourceManager",
            "type": "go",
            "request": "launch",
            "mode": "auto",
            "program": "${workspaceFolder}/cmd/resourcemanager/main.go",
            "args": ["-port", "8088"],
            "env": {
                "LOG_LEVEL": "DEBUG"
            },
            "console": "integratedTerminal"
        },
        {
            "name": "Debug NodeManager",
            "type": "go",
            "request": "launch",
            "mode": "auto",
            "program": "${workspaceFolder}/cmd/nodemanager/main.go",
            "args": [
                "-port", "8042",
                "-host", "localhost",
                "-rm-url", "http://localhost:8088",
                "-memory", "4096",
                "-vcores", "4"
            ],
            "env": {
                "LOG_LEVEL": "DEBUG"
            },
            "console": "integratedTerminal"
        },
        {
            "name": "Debug Client",
            "type": "go",
            "request": "launch",
            "mode": "auto",
            "program": "${workspaceFolder}/cmd/client/main.go",
            "args": [
                "-rm-url", "http://localhost:8088",
                "-app-name", "debug-test",
                "-command", "echo 'Debug test'"
            ],
            "console": "integratedTerminal"
        },
        {
            "name": "Attach to Process",
            "type": "go",
            "request": "attach",
            "mode": "local",
            "processId": 0
        }
    ]
}
```

### GoLand/IntelliJ 配置

1. 右键点击 `main.go` 文件
2. 选择 "Debug 'go build main.go'"
3. 在 Run Configuration 中设置参数和环境变量

### 2. 命令行调试

#### 使用 Delve 调试器

安装 Delve：

```bash
go install github.com/go-delve/delve/cmd/dlv@latest
```

调试 ResourceManager：

```bash
# 编译并启动调试器
dlv debug cmd/resourcemanager/main.go -- -port 8088

# 在调试器中设置断点
(dlv) break main.main
(dlv) break internal/resourcemanager.(*ResourceManager).Start
(dlv) continue
```

调试 NodeManager：

```bash
dlv debug cmd/nodemanager/main.go -- -port 8042 -host localhost -rm-url http://localhost:8088
```

#### 远程调试

启动带调试监听的服务：

```bash
# ResourceManager 远程调试
dlv --listen=:2345 --headless=true --api-version=2 debug cmd/resourcemanager/main.go -- -port 8088

# 连接到远程调试会话
dlv connect :2345
```

## 日志调试

### 1. 增强日志配置

更新日志格式以包含更多调试信息：

```go
// 在 main.go 中添加
import (
    "log"
    "os"
)

func init() {
    // 设置日志格式
    log.SetFlags(log.LstdFlags | log.Lshortfile | log.Lmicroseconds)
    
    // 根据环境变量设置日志级别
    if os.Getenv("LOG_LEVEL") == "DEBUG" {
        log.SetOutput(os.Stdout)
    }
}
```

### 2. 结构化日志

添加结构化日志支持：

```go
type Logger struct {
    level string
}

func (l *Logger) Debug(format string, args ...interface{}) {
    if l.level == "DEBUG" {
        log.Printf("[DEBUG] "+format, args...)
    }
}

func (l *Logger) Info(format string, args ...interface{}) {
    log.Printf("[INFO] "+format, args...)
}

func (l *Logger) Error(format string, args ...interface{}) {
    log.Printf("[ERROR] "+format, args...)
}
```

### 3. 分组件日志

为不同组件创建独立的日志文件：

```bash
# 启动时重定向日志
./bin/resourcemanager -port 8088 > logs/rm-$(date +%Y%m%d-%H%M%S).log 2>&1 &
./bin/nodemanager -port 8042 > logs/nm-$(date +%Y%m%d-%H%M%S).log 2>&1 &
```

## 单元测试调试

### 1. 创建测试文件

创建组件测试：

```go
// internal/resourcemanager/resource_manager_test.go
package resourcemanager

import (
    "testing"
    "time"
    "carrot/internal/common"
)

func TestResourceManagerCreation(t *testing.T) {
    rm := NewResourceManager()
    if rm == nil {
        t.Fatal("Failed to create ResourceManager")
    }
    
    if rm.clusterTimestamp == 0 {
        t.Error("Cluster timestamp not set")
    }
}

func TestNodeRegistration(t *testing.T) {
    rm := NewResourceManager()
    
    nodeID := common.NodeID{
        Host: "test-host",
        Port: 8042,
    }
    
    resource := common.Resource{
        Memory: 4096,
        VCores: 4,
    }
    
    err := rm.RegisterNode(nodeID, resource, "http://test-host:8042")
    if err != nil {
        t.Fatalf("Failed to register node: %v", err)
    }
    
    nodes := rm.GetNodes()
    if len(nodes) != 1 {
        t.Errorf("Expected 1 node, got %d", len(nodes))
    }
}
```

运行特定测试并显示详细输出：

```bash
# 运行单个测试
go test -v ./internal/resourcemanager -run TestResourceManagerCreation

# 运行所有测试
go test -v ./...

# 运行测试并显示覆盖率
go test -v -cover ./...

# 生成覆盖率报告
go test -coverprofile=out/coverage.out ./...
go tool cover -html=out/coverage.out -o out/coverage.html
```

### 2. 基准测试

添加性能基准测试：

```go
func BenchmarkResourceManagerScheduling(b *testing.B) {
    rm := NewResourceManager()
    
    // 注册测试节点
    nodeID := common.NodeID{Host: "bench-host", Port: 8042}
    resource := common.Resource{Memory: 8192, VCores: 8}
    rm.RegisterNode(nodeID, resource, "http://bench-host:8042")
    
    b.ResetTimer()
    
    for i := 0; i < b.N; i++ {
        appID := common.ApplicationID{
            ClusterTimestamp: time.Now().Unix(),
            ID: int32(i),
        }
        
        ctx := common.ApplicationSubmissionContext{
            ApplicationID: appID,
            ApplicationName: fmt.Sprintf("bench-app-%d", i),
            Resource: common.Resource{Memory: 1024, VCores: 1},
        }
        
        _, err := rm.SubmitApplication(ctx)
        if err != nil {
            b.Fatal(err)
        }
    }
}
```
