# Carrot YARN 配置文件使用指南

本项目已更新为使用配置文件而不是命令行参数启动各个组件。这样做的好处包括：

- 配置更加结构化和易于管理
- 支持复杂的集群配置
- 便于部署和维护
- 配置文件可以版本化管理

## 配置文件

项目包含三个主要组件的配置文件：

- `configs/resourcemanager.yaml` - ResourceManager 配置
- `configs/nodemanager.yaml` - NodeManager 配置
- `configs/applicationmaster.yaml` - ApplicationMaster 配置

## 启动方式

### 1. 使用配置文件启动单个组件

#### ResourceManager
```bash
./bin/resourcemanager -config=configs/resourcemanager.yaml
```

#### NodeManager
```bash
./bin/nodemanager -config=configs/nodemanager.yaml
```

#### ApplicationMaster
```bash
./bin/applicationmaster -config=configs/applicationmaster.yaml \
    -application_id="1693123456_1" \
    -application_attempt_id="1693123456_1_1"
```

### 2. 使用启动脚本

我们提供了便捷的启动脚本：

```bash
# 启动 ResourceManager
./scripts/start-resourcemanager.sh

# 启动 NodeManager
./scripts/start-nodemanager.sh

# 启动 ApplicationMaster
./scripts/start-applicationmaster.sh [app_id] [attempt_id]

# 启动整个集群
./scripts/start-cluster.sh

# 停止集群
./scripts/stop-cluster.sh
```

## 配置文件说明

### ResourceManager 配置 (resourcemanager.yaml)

```yaml
# 集群配置
cluster:
  name: "carrot-cluster"
  id: "rm-1"
  discovery_method: "static"

# ResourceManager 特定配置
resourcemanager:
  port: 8088
  address: "0.0.0.0"
  heartbeat_interval: 3s
  node_expiry_timeout: 600s
  application_max_attempts: 2

# 调度器配置
scheduler:
  type: "fifo"  # fifo, capacity, fair
  max_apps: 10000
```

### NodeManager 配置 (nodemanager.yaml)

```yaml
# 集群配置
cluster:
  name: "carrot-cluster"
  id: "nm-1"

# NodeManager 特定配置
nodemanager:
  port: 8042
  address: "0.0.0.0"
  resourcemanager_url: "http://localhost:8088"
  heartbeat_interval: 3s
  container_memory_limit_mb: 8192
  container_vcores_limit: 8
```

### ApplicationMaster 配置 (applicationmaster.yaml)

```yaml
# 集群配置
cluster:
  name: "carrot-cluster"
  id: "am-1"

# ApplicationMaster 特定配置
applicationmaster:
  port: 8088
  address: "0.0.0.0"
  resourcemanager_url: "http://localhost:8030"
  heartbeat_interval: 10s
  max_retries: 3
  app_type: "simple"  # simple, distributed
  num_tasks: 3
  num_workers: 2
```

## 配置参数说明

### 集群配置
- `name`: 集群名称，所有组件应该使用相同的名称
- `id`: 组件的唯一标识符
- `discovery_method`: 服务发现方法 (static, dns, etcd, consul)

### 网络配置
- `port`: 服务监听端口
- `address`: 服务绑定地址（通常是 "0.0.0.0"）

### 心跳配置
- `heartbeat_interval`: 心跳间隔
- `heartbeat_timeout`: 心跳超时时间
- `monitor_interval`: 监控检查间隔

### 资源配置
- `container_memory_limit_mb`: 容器内存限制（MB）
- `container_vcores_limit`: 容器虚拟核心数限制

## 自定义配置

你可以复制现有的配置文件并根据需要修改：

```bash
# 复制默认配置
cp configs/resourcemanager.yaml configs/resourcemanager-prod.yaml

# 编辑配置
vim configs/resourcemanager-prod.yaml

# 使用自定义配置启动
./bin/resourcemanager -config=configs/resourcemanager-prod.yaml
```

## 环境变量支持

配置文件支持从环境变量读取敏感信息：

```yaml
security:
  secret_key: ""  # 将从 CARROT_SECRET_KEY 环境变量读取
```

## 验证配置

启动后可以通过以下方式验证配置：

```bash
# 检查 ResourceManager 状态
curl http://localhost:8088/ws/v1/cluster/info

# 检查节点状态
curl http://localhost:8088/ws/v1/cluster/nodes

# 查看日志
tail -f logs/resourcemanager.log
tail -f logs/nodemanager.log
```

## 常见问题

1. **配置文件找不到**: 确保配置文件路径正确，或使用绝对路径
2. **端口冲突**: 修改配置文件中的端口号
3. **集群名称不匹配**: 确保所有组件使用相同的集群名称
4. **连接失败**: 检查 ResourceManager URL 配置是否正确

## 开发模式

开发时可以使用 `-dev` 参数启用调试日志：

```bash
./bin/resourcemanager -config=configs/resourcemanager.yaml -dev
```
