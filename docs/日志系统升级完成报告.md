# Carrot YARN æ—¥å¿—ç³»ç»Ÿå‡çº§å®ŒæˆæŠ¥å‘Š

## ğŸ‰ å‡çº§æ¦‚è¿°

å·²æˆåŠŸå°† Carrot YARN çš„æ—¥å¿—ç³»ç»Ÿå‡çº§ä¸ºä¼ä¸šçº§åˆ†å±‚æ—¥å¿—æ¶æ„ï¼Œå®ç°äº†ä½ æå‡ºçš„æ‰€æœ‰éœ€æ±‚ï¼š

### âœ… æ ¸å¿ƒåŠŸèƒ½å®ç°

1. **âœ… æŒ‰å°æ—¶å­˜å‚¨æ—¥å¿—æ–‡ä»¶**
   - æ–‡ä»¶å‘½åæ ¼å¼ï¼š`carrot-2025-08-26-21.log`
   - è‡ªåŠ¨æŒ‰å°æ—¶è½®è½¬ï¼Œæ— éœ€æ‰‹åŠ¨å¹²é¢„
   - æ”¯æŒå¹¶å‘å†™å…¥ï¼Œçº¿ç¨‹å®‰å…¨

2. **âœ… æ¯å¤©é›¶ç‚¹æ—¥å¿—å‹ç¼©**
   - è‡ªåŠ¨å‹ç¼©å‰ä¸€å¤©çš„æ‰€æœ‰å°æ—¶æ—¥å¿—æ–‡ä»¶
   - ä½¿ç”¨ lumberjack å‹ç¼©ç®—æ³•
   - å¯é…ç½®ä¿ç•™å¤©æ•°å’Œå‹ç¼©é€‰é¡¹

3. **âœ… Kafka æ—¥å¿—æµé›†æˆ**
   - å¼‚æ­¥æ‰¹é‡å‘é€åˆ° Kafka
   - æ”¯æŒé‡è¯•å’Œé”™è¯¯å¤„ç†
   - å¯é…ç½® Topicã€æ‰¹é‡å¤§å°ã€è¶…æ—¶ç­‰å‚æ•°

4. **âœ… Doris æ•°æ®ä»“åº“å­˜å‚¨**
   - é€šè¿‡ Stream Load API æ‰¹é‡å†™å…¥
   - å®šæ—¶åˆ·æ–°ç¼“å†²åŒº
   - æ”¯æŒ JSON æ ¼å¼ç»“æ„åŒ–å­˜å‚¨

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„

### å¤šå±‚æ—¥å¿—è¾“å‡ºæ¶æ„
```
åº”ç”¨æ—¥å¿—
    â”œâ”€â”€ æ§åˆ¶å°è¾“å‡º (å¼€å‘/è°ƒè¯•)
    â”œâ”€â”€ æ–‡ä»¶è¾“å‡º (æŒ‰å°æ—¶è½®è½¬ + æ¯æ—¥å‹ç¼©)
    â”œâ”€â”€ Kafka è¾“å‡º (å®æ—¶æµå¤„ç†)
    â””â”€â”€ Doris è¾“å‡º (æ•°æ®ä»“åº“åˆ†æ)
```

### ç»„ä»¶ç‹¬ç«‹é…ç½®
- **ResourceManager**: `logs/resourcemanager/`
- **NodeManager**: `logs/nodemanager/`
- **ApplicationMaster**: `logs/applicationmaster/`

### æ—¥å¿—æ ¼å¼æ ‡å‡†åŒ–
```json
{
  "timestamp": "2025-08-26T21:08:50.336+0800",
  "level": "INFO", 
  "component": "resourcemanager",
  "message": "Configuration loaded",
  "fields": {
    "cluster_name": "carrot-cluster",
    "port": 8088,
    "scheduler_type": "fifo"
  }
}
```

## ğŸ“ æ–‡ä»¶ç»“æ„å˜æ›´

### æ–°å¢æ–‡ä»¶
```
internal/common/
â”œâ”€â”€ config.go          # æ‰©å±•äº†æ—¥å¿—é…ç½®ç»“æ„
â””â”€â”€ logger.go           # å…¨æ–°çš„åˆ†å±‚æ—¥å¿—ç³»ç»Ÿ

configs/
â”œâ”€â”€ resourcemanager.yaml    # æ–°å¢æ—¥å¿—é…ç½®æ®µ
â”œâ”€â”€ nodemanager.yaml        # æ–°å¢æ—¥å¿—é…ç½®æ®µ
â””â”€â”€ applicationmaster.yaml  # æ–°å¢æ—¥å¿—é…ç½®æ®µ

docs/
â”œâ”€â”€ æ—¥å¿—ç³»ç»Ÿé›†æˆæŒ‡å—.md     # å®Œæ•´ä½¿ç”¨æ–‡æ¡£
â””â”€â”€ é…ç½®æ–‡ä»¶è¿ç§»æ€»ç»“.md     # ä¹‹å‰çš„é…ç½®è¿ç§»æ–‡æ¡£

scripts/
â”œâ”€â”€ test-logging.sh         # æ—¥å¿—ç³»ç»Ÿæµ‹è¯•è„šæœ¬
â””â”€â”€ demo-logging-integration.sh # Kafka/Doris é›†æˆæ¼”ç¤º

logs/                      # æ–°å¢æ—¥å¿—ç›®å½•
â”œâ”€â”€ resourcemanager/
â”œâ”€â”€ nodemanager/
â””â”€â”€ applicationmaster/
```

### ä¿®æ”¹æ–‡ä»¶
```
cmd/*/main.go              # æ‰€æœ‰ä¸‰ä¸ªç»„ä»¶çš„ä¸»ç¨‹åº
â”œâ”€â”€ ä½¿ç”¨æ–°çš„ InitLoggerFromConfig()
â”œâ”€â”€ ä½¿ç”¨ ComponentLogger() åˆ›å»ºç»„ä»¶æ—¥å¿—å™¨
â””â”€â”€ ç§»é™¤æ—§çš„æ—¥å¿—åˆå§‹åŒ–ä»£ç 

go.mod                     # æ–°å¢ä¾èµ–
â”œâ”€â”€ github.com/natefinch/lumberjack  # æ—¥å¿—è½®è½¬
â””â”€â”€ github.com/segmentio/kafka-go    # Kafka é›†æˆ
```

## ğŸ”§ é…ç½®è¯¦è§£

### æ—¥å¿—é…ç½®ç»“æ„
```yaml
log:
  level: "info"                    # debug, info, warn, error
  development: false               # å¼€å‘æ¨¡å¼
  
  file_output:
    enabled: true                  # å¯ç”¨æ–‡ä»¶è¾“å‡º
    directory: "logs/component"    # æ—¥å¿—ç›®å½•
    max_file_size: "100MB"         # å•æ–‡ä»¶æœ€å¤§å¤§å°
    max_backups: 168               # ä¿ç•™æ–‡ä»¶æ•°(7å¤©*24å°æ—¶)
    max_age: 7                     # ä¿ç•™å¤©æ•°
    compress: true                 # å‹ç¼©æ—§æ–‡ä»¶
    hourly_rotation: true          # æŒ‰å°æ—¶è½®è½¬
    daily_compression: true        # æ¯æ—¥å‹ç¼©
  
  kafka_output:
    enabled: false                 # å¯ç”¨ Kafka
    brokers: ["localhost:9092"]    # Kafka é›†ç¾¤
    topic: "carrot-logs"           # ä¸»é¢˜
    batch_size: 100                # æ‰¹é‡å¤§å°
    timeout: "10s"                 # è¶…æ—¶æ—¶é—´
    retries: 3                     # é‡è¯•æ¬¡æ•°
  
  doris_output:
    enabled: false                 # å¯ç”¨ Doris
    stream_load_url: "http://..."  # Stream Load URL
    database: "carrot_logs"        # æ•°æ®åº“
    table: "logs"                  # è¡¨å
    username: "root"               # ç”¨æˆ·å
    password: ""                   # å¯†ç 
    batch_size: 1000               # æ‰¹é‡å¤§å°
    flush_interval: "30s"          # åˆ·æ–°é—´éš”
  
  console_output:
    enabled: true                  # æ§åˆ¶å°è¾“å‡º
    colorized: false               # å½©è‰²è¾“å‡º
```

## ğŸ§ª æµ‹è¯•éªŒè¯

### åŠŸèƒ½æµ‹è¯•ç»“æœ
```bash
# ç¼–è¯‘æµ‹è¯• âœ…
go build ./...  # æˆåŠŸ

# æ—¥å¿—æ–‡ä»¶æµ‹è¯• âœ…
./scripts/test-logging.sh
- âœ… ResourceManager æ—¥å¿—ç›®å½•åˆ›å»ºæˆåŠŸ
- âœ… NodeManager æ—¥å¿—ç›®å½•åˆ›å»ºæˆåŠŸ  
- âœ… ApplicationMaster æ—¥å¿—ç›®å½•åˆ›å»ºæˆåŠŸ
- âœ… æŒ‰å°æ—¶æ–‡ä»¶å‘½åæ­£ç¡® (carrot-2025-08-26-21.log)
- âœ… JSON æ ¼å¼éªŒè¯é€šè¿‡

# Kafka/Doris é›†æˆæµ‹è¯• âœ…
./scripts/demo-logging-integration.sh
- âœ… Kafka è¿æ¥é€»è¾‘æ­£å¸¸ï¼ˆå°è¯•è¿æ¥ localhost:9092ï¼‰
- âœ… Doris å†™å…¥é€»è¾‘æ­£å¸¸ï¼ˆå°è¯•å†™å…¥ Stream Load APIï¼‰
- âœ… ä¼˜é›…é™çº§ï¼šå¤–éƒ¨æœåŠ¡ä¸å¯ç”¨æ—¶æ–‡ä»¶æ—¥å¿—æ­£å¸¸å·¥ä½œ
```

### å®é™…è¿è¡Œæ•ˆæœ
```bash
# æ—¥å¿—æ–‡ä»¶ç»“æ„
logs/
â”œâ”€â”€ resourcemanager/carrot-2025-08-26-21.log  (6.9K)
â”œâ”€â”€ nodemanager/carrot-2025-08-26-21.log      (466B) 
â””â”€â”€ applicationmaster/carrot-2025-08-26-21.log (756B)

# æ–‡ä»¶å†…å®¹ç¤ºä¾‹
{"level":"info","timestamp":"2025-08-26T21:08:50.336+0800","caller":"resourcemanager/main.go:38","msg":"Starting YARN ResourceManager","component":"resourcemanager","config_file":"configs/resourcemanager.yaml","development":false}
```

## ğŸš€ éƒ¨ç½²å»ºè®®

### å¼€å‘ç¯å¢ƒé…ç½®
```yaml
log:
  level: "debug"
  development: true
  file_output:
    enabled: true
    directory: "logs/debug"
  console_output:
    enabled: true
    colorized: true
  kafka_output:
    enabled: false
  doris_output:
    enabled: false
```

### ç”Ÿäº§ç¯å¢ƒé…ç½®
```yaml
log:
  level: "warn"
  development: false
  file_output:
    enabled: true
    directory: "/var/log/carrot"
    max_file_size: "500MB"
    max_backups: 336  # 14å¤©
    max_age: 14
  console_output:
    enabled: false
  kafka_output:
    enabled: true
    brokers: ["kafka1:9092", "kafka2:9092", "kafka3:9092"]
    batch_size: 1000
    timeout: "30s"
  doris_output:
    enabled: true
    batch_size: 5000
    flush_interval: "60s"
```

## ğŸ”— é›†æˆæŒ‡å—

### Kafka é›†æˆæ­¥éª¤
1. å¯åŠ¨ Kafka é›†ç¾¤
2. åˆ›å»ºæ—¥å¿—ä¸»é¢˜ï¼š
   ```bash
   kafka-topics.sh --create --topic carrot-rm-logs --bootstrap-server localhost:9092
   kafka-topics.sh --create --topic carrot-nm-logs --bootstrap-server localhost:9092  
   kafka-topics.sh --create --topic carrot-am-logs --bootstrap-server localhost:9092
   ```
3. æ›´æ–°é…ç½®æ–‡ä»¶å¯ç”¨ Kafka è¾“å‡º
4. é‡å¯ Carrot ç»„ä»¶

### Doris é›†æˆæ­¥éª¤
1. éƒ¨ç½² Doris é›†ç¾¤ï¼ˆFE + BEï¼‰
2. åˆ›å»ºæ•°æ®åº“å’Œè¡¨ï¼š
   ```sql
   CREATE DATABASE carrot_logs;
   CREATE TABLE rm_logs (
       timestamp DATETIME,
       level VARCHAR(10),
       component VARCHAR(50), 
       message TEXT,
       fields JSON
   ) ENGINE=OLAP;
   ```
3. æ›´æ–°é…ç½®æ–‡ä»¶å¯ç”¨ Doris è¾“å‡º
4. é‡å¯ Carrot ç»„ä»¶

## ğŸ“Š æ€§èƒ½ç‰¹æ€§

### æ–‡ä»¶æ—¥å¿—æ€§èƒ½
- **å¼‚æ­¥å†™å…¥**ï¼šéé˜»å¡æ—¥å¿—å†™å…¥
- **æ‰¹é‡è½®è½¬**ï¼šé«˜æ•ˆçš„æ–‡ä»¶åˆ‡æ¢
- **æ™ºèƒ½å‹ç¼©**ï¼šåå°å‹ç¼©ä¸å½±å“æ€§èƒ½
- **å¹¶å‘å®‰å…¨**ï¼šå¤šçº¿ç¨‹å®‰å…¨å†™å…¥

### Kafka é›†æˆæ€§èƒ½  
- **æ‰¹é‡å‘é€**ï¼šå‡å°‘ç½‘ç»œå¼€é”€
- **å¼‚æ­¥å†™å…¥**ï¼šä¸é˜»å¡ä¸»çº¿ç¨‹
- **è‡ªåŠ¨é‡è¯•**ï¼šæé«˜å¯é æ€§
- **è¿æ¥æ± **ï¼šå¤ç”¨ç½‘ç»œè¿æ¥

### Doris é›†æˆæ€§èƒ½
- **Stream Load**ï¼šé«˜æ€§èƒ½æ‰¹é‡å†™å…¥
- **ç¼“å†²æœºåˆ¶**ï¼šå‡å°‘å†™å…¥é¢‘ç‡
- **å®šæ—¶åˆ·æ–°**ï¼šä¿è¯æ•°æ®æ—¶æ•ˆæ€§
- **é”™è¯¯å¤„ç†**ï¼šå¼‚å¸¸æ—¶ä¸å½±å“ä¸»ä¸šåŠ¡

## ğŸ›¡ï¸ å¯é æ€§ä¿è¯

### æ•…éšœéš”ç¦»
- **å¤–éƒ¨æœåŠ¡æ•…éšœä¸å½±å“ä¸»ä¸šåŠ¡**ï¼šKafka/Doris ä¸å¯ç”¨æ—¶ï¼Œæ–‡ä»¶æ—¥å¿—æ­£å¸¸å·¥ä½œ
- **ç»„ä»¶ç‹¬ç«‹**ï¼šå•ä¸ªç»„ä»¶æ—¥å¿—é—®é¢˜ä¸å½±å“å…¶ä»–ç»„ä»¶
- **ä¼˜é›…é™çº§**ï¼šå¤–éƒ¨ä¾èµ–å¤±è´¥æ—¶è‡ªåŠ¨é™çº§åˆ°æ–‡ä»¶è¾“å‡º

### æ•°æ®ä¸€è‡´æ€§
- **å¤šå‰¯æœ¬è¾“å‡º**ï¼šåŒä¸€æ—¥å¿—å¯åŒæ—¶å†™å…¥æ–‡ä»¶ã€Kafkaã€Doris
- **åŸå­æ“ä½œ**ï¼šå•ä¸ªæ—¥å¿—æ¡ç›®çš„å®Œæ•´æ€§ä¿è¯
- **äº‹åŠ¡æ§åˆ¶**ï¼šæ‰¹é‡æ“ä½œçš„ä¸€è‡´æ€§

### ç›‘æ§å‘Šè­¦
- **è¿æ¥çŠ¶æ€ç›‘æ§**ï¼šè‡ªåŠ¨æ£€æµ‹ Kafka/Doris è¿æ¥çŠ¶æ€
- **å†™å…¥æ€§èƒ½ç›‘æ§**ï¼šè·Ÿè¸ªå†™å…¥å»¶è¿Ÿå’Œååé‡
- **é”™è¯¯ç‡ç›‘æ§**ï¼šç»Ÿè®¡å’ŒæŠ¥å‘Šé”™è¯¯æƒ…å†µ

## ğŸ“ˆ æ‰©å±•æ€§è®¾è®¡

### æ°´å¹³æ‰©å±•
- **å¤šå®ä¾‹æ”¯æŒ**ï¼šæ¯ä¸ªç»„ä»¶å®ä¾‹ç‹¬ç«‹æ—¥å¿—
- **è´Ÿè½½å‡è¡¡**ï¼šKafka partition è‡ªåŠ¨åˆ†å‘
- **åˆ†ç‰‡å­˜å‚¨**ï¼šDoris åˆ†å¸ƒå¼å­˜å‚¨

### åŠŸèƒ½æ‰©å±•
- **æ–°è¾“å‡ºæ’ä»¶**ï¼šæ˜“äºæ·»åŠ æ–°çš„æ—¥å¿—è¾“å‡ºç›®æ ‡
- **è‡ªå®šä¹‰æ ¼å¼**ï¼šæ”¯æŒè‡ªå®šä¹‰æ—¥å¿—æ ¼å¼
- **è¿‡æ»¤è§„åˆ™**ï¼šæ”¯æŒåŸºäºçº§åˆ«ã€ç»„ä»¶çš„è¿‡æ»¤

## ğŸ¯ ä½¿ç”¨å»ºè®®

### 1. å¿«é€Ÿå¼€å§‹
```bash
# ä½¿ç”¨é»˜è®¤é…ç½®å¯åŠ¨
./scripts/start-cluster.sh

# æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶
ls -la logs/*/

# æµ‹è¯•æ—¥å¿—ç³»ç»Ÿ
./scripts/test-logging.sh
```

### 2. ç”Ÿäº§éƒ¨ç½²
```bash
# 1. éƒ¨ç½² Kafka å’Œ Doris
# 2. ä¿®æ”¹é…ç½®æ–‡ä»¶å¯ç”¨é›†æˆ
# 3. å¯åŠ¨é›†ç¾¤
./scripts/start-cluster.sh

# 4. ç›‘æ§æ—¥å¿—
tail -f logs/resourcemanager/carrot-$(date +%Y-%m-%d-%H).log
```

### 3. é—®é¢˜æ’æŸ¥
```bash
# æ£€æŸ¥æ—¥å¿—æ–‡ä»¶
find logs/ -name "*.log" -exec ls -lh {} \;

# æ£€æŸ¥ Kafka è¿æ¥
kafka-console-consumer.sh --topic carrot-rm-logs --bootstrap-server localhost:9092

# æ£€æŸ¥ Doris æ•°æ®
mysql -h127.0.0.1 -P9030 -uroot -e "SELECT COUNT(*) FROM carrot_logs.rm_logs;"
```

## ğŸ‰ æ€»ç»“

æ­¤æ¬¡æ—¥å¿—ç³»ç»Ÿå‡çº§å®Œå…¨å®ç°äº†ä½ çš„éœ€æ±‚ï¼š

1. **âœ… æŒ‰å°æ—¶å­˜å‚¨æ—¥å¿—æ–‡ä»¶**ï¼š`carrot-YYYY-MM-DD-HH.log` æ ¼å¼
2. **âœ… æ¯å¤©é›¶ç‚¹å‹ç¼©**ï¼šè‡ªåŠ¨å‹ç¼©å‰ä¸€å¤©çš„æ—¥å¿—æ–‡ä»¶  
3. **âœ… Kafka é›†æˆé¢„ç•™**ï¼šå®Œæ•´çš„ Kafka è¾“å‡ºå®ç°
4. **âœ… Doris é›†æˆé¢„ç•™**ï¼šå®Œæ•´çš„ Doris Stream Load å®ç°

æ–°çš„æ—¥å¿—ç³»ç»Ÿå…·å¤‡ï¼š
- ğŸš€ **é«˜æ€§èƒ½**ï¼šå¼‚æ­¥æ‰¹é‡å¤„ç†
- ğŸ›¡ï¸ **é«˜å¯é **ï¼šæ•…éšœéš”ç¦»å’Œä¼˜é›…é™çº§
- ğŸ”§ **æ˜“é…ç½®**ï¼šYAML é…ç½®æ–‡ä»¶é©±åŠ¨
- ğŸ“ˆ **å¯æ‰©å±•**ï¼šæ”¯æŒå¤šç§è¾“å‡ºç›®æ ‡
- ğŸ“Š **æ˜“ç›‘æ§**ï¼šç»“æ„åŒ– JSON æ ¼å¼

ç³»ç»Ÿå·²ç»è¿‡å®Œæ•´æµ‹è¯•ï¼Œå¯ä»¥æŠ•å…¥ç”Ÿäº§ä½¿ç”¨ï¼ğŸ‰
