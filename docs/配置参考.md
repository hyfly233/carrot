# Carrot YARN 配置参考

本文档提供 Carrot YARN 所有组件的完整配置参考。

## 📋 目录

- [通用配置](#通用配置)
- [ResourceManager 配置](#resourcemanager-配置)
- [NodeManager 配置](#nodemanager-配置)
- [ApplicationMaster 配置](#applicationmaster-配置)
- [调度器配置](#调度器配置)
- [安全配置](#安全配置)
- [监控配置](#监控配置)
- [网络配置](#网络配置)
- [环境变量](#环境变量)
- [配置示例](#配置示例)

## 🌐 通用配置

### 基础配置

| 配置项            | 类型     | 默认值                | 描述                              |
|----------------|--------|--------------------|---------------------------------|
| `cluster.name` | string | `"carrot-cluster"` | 集群名称                            |
| `cluster.id`   | string | `""`               | 集群唯一标识符                         |
| `data.dir`     | string | `"/tmp/carrot"`    | 数据存储目录                          |
| `temp.dir`     | string | `"/tmp"`           | 临时文件目录                          |
| `log.level`    | string | `"info"`           | 日志级别 (debug, info, warn, error) |
| `log.format`   | string | `"json"`           | 日志格式 (text, json)               |

### 网络配置

| 配置项                       | 类型       | 默认值         | 描述     |
|---------------------------|----------|-------------|--------|
| `network.bind.host`       | string   | `"0.0.0.0"` | 绑定主机地址 |
| `network.publish.host`    | string   | `""`        | 发布主机地址 |
| `network.timeout.connect` | duration | `"30s"`     | 连接超时时间 |
| `network.timeout.read`    | duration | `"30s"`     | 读取超时时间 |
| `network.timeout.write`   | duration | `"30s"`     | 写入超时时间 |

### 资源配置

| 配置项                       | 类型     | 默认值      | 描述          |
|---------------------------|--------|----------|-------------|
| `resource.memory.minimum` | string | `"512m"` | 最小内存分配单位    |
| `resource.cpu.minimum`    | float  | `0.1`    | 最小 CPU 分配单位 |
| `resource.memory.maximum` | string | `"8g"`   | 最大内存分配单位    |
| `resource.cpu.maximum`    | float  | `8.0`    | 最大 CPU 分配单位 |

## 🏢 ResourceManager 配置

### 服务配置

```yaml
resourcemanager:
  # 服务器配置
  server:
    host: "0.0.0.0"
    port: 8088

    # TLS 配置
    tls:
      enabled: false
      cert_file: ""
      key_file: ""
      ca_file: ""

  # 应用程序配置
  application:
    # 最大运行应用程序数
    max_running_apps: 1000
    # 最大待处理应用程序数
    max_pending_apps: 500
    # 应用程序过期时间
    expiry_time: "7d"
    # 应用程序清理间隔
    cleanup_interval: "1h"

  # 节点配置
  node:
    # 心跳间隔
    heartbeat_interval: "1s"
    # 心跳超时
    heartbeat_timeout: "10m"
    # 不健康节点清理间隔
    cleanup_interval: "10m"
    # 包含模式
    include_pattern: ""
    # 排除模式
    exclude_pattern: ""

  # 调度器配置
  scheduler:
    # 调度器类型: fifo, capacity, fair
    type: "capacity"
    # 调度间隔
    schedule_interval: "100ms"
    # 最大分配尝试次数
    max_allocation_attempts: 3
    # 调度器配置文件
    config_file: "configs/capacity-scheduler.xml"

  # 恢复配置
  recovery:
    # 是否启用恢复
    enabled: true
    # 状态存储类型: memory, file, etcd
    store_type: "file"
    # 存储目录
    store_dir: "data/rm-state"
    # 恢复超时
    timeout: "60s"

  # 安全配置
  security:
    # 是否启用安全
    enabled: false
    # 认证类型: simple, kerberos, jwt
    auth_type: "simple"
    # ACL 启用
    acl_enabled: false
    # 管理员用户
    admin_users: [ "admin" ]
    # 管理员组
    admin_groups: [ "admin" ]
```

### 环境变量

| 环境变量           | 默认值         | 描述                   |
|----------------|-------------|----------------------|
| `RM_HOST`      | `localhost` | ResourceManager 主机地址 |
| `RM_PORT`      | `8088`      | ResourceManager 端口   |
| `RM_HEAP_SIZE` | `1024m`     | JVM 堆大小              |
| `RM_LOG_LEVEL` | `info`      | 日志级别                 |

## 🖥️ NodeManager 配置

### 服务配置

```yaml
nodemanager:
  # 服务器配置
  server:
    host: "0.0.0.0"
    port: 8042

    # TLS 配置
    tls:
      enabled: false
      cert_file: ""
      key_file: ""
      ca_file: ""

  # ResourceManager 连接配置
  resourcemanager:
    host: "localhost"
    port: 8088
    # 连接重试次数
    connect_retries: 3
    # 连接重试间隔
    retry_interval: "5s"

  # 节点资源配置
  resources:
    # 内存资源 (MB)
    memory: 8192
    # CPU 资源 (vCores)
    vcores: 8
    # 是否检测物理资源
    detect_hardware: true
    # 内存使用率阈值
    memory_threshold: 0.8
    # CPU 使用率阈值
    cpu_threshold: 0.8

  # 容器配置
  containers:
    # 执行器类型: default, linux
    executor_type: "default"
    # 最大容器数
    max_containers: 100
    # 容器内存最小值
    min_memory: 512
    # 容器内存最大值
    max_memory: 8192
    # 容器启动超时
    launch_timeout: "60s"
    # 容器清理间隔
    cleanup_interval: "10m"

  # 本地化配置
  localizer:
    # 本地缓存目录
    cache_dir: "cache"
    # 缓存大小限制
    cache_size_limit: "10g"
    # 缓存清理间隔
    cleanup_interval: "1h"
    # 并发下载数
    concurrent_downloads: 5
    # 下载超时
    download_timeout: "10m"

  # 健康检查配置
  health:
    # 检查间隔
    check_interval: "30s"
    # 磁盘检查
    disk_check_enabled: true
    # 磁盘使用率阈值
    disk_threshold: 0.9
    # 内存检查
    memory_check_enabled: true
    # CPU 检查
    cpu_check_enabled: true

  # 监控配置
  monitoring:
    # 是否启用监控
    enabled: true
    # 监控间隔
    interval: "10s"
    # 历史数据保留时间
    retention: "24h"
    # 指标存储目录
    metrics_dir: "metrics"

  # 安全配置
  security:
    # 是否启用安全
    enabled: false
    # 运行用户检查
    check_user: false
    # 容器用户
    container_user: "nobody"
```

### 环境变量

| 环境变量           | 默认值         | 描述               |
|----------------|-------------|------------------|
| `NM_HOST`      | `localhost` | NodeManager 主机地址 |
| `NM_PORT`      | `8042`      | NodeManager 端口   |
| `NM_MEMORY`    | `8192`      | 节点内存大小 (MB)      |
| `NM_VCORES`    | `8`         | 节点 CPU 核心数       |
| `NM_HEAP_SIZE` | `1024m`     | JVM 堆大小          |

## 📱 ApplicationMaster 配置

### 服务配置

```yaml
applicationmaster:
  # 服务器配置
  server:
    host: "0.0.0.0"
    port: 8080

    # TLS 配置
    tls:
      enabled: false
      cert_file: ""
      key_file: ""
      ca_file: ""

  # ResourceManager 连接配置
  resourcemanager:
    host: "localhost"
    port: 8088
    # 注册重试次数
    register_retries: 3
    # 注册重试间隔
    retry_interval: "5s"
    # 心跳间隔
    heartbeat_interval: "1s"

  # 容器配置
  containers:
    # 最大容器请求数
    max_container_requests: 1000
    # 容器请求间隔
    request_interval: "100ms"
    # 容器释放超时
    release_timeout: "30s"

  # 任务配置
  tasks:
    # 最大重试次数
    max_retries: 3
    # 重试间隔
    retry_interval: "10s"
    # 任务超时
    timeout: "30m"

  # 应用程序配置
  application:
    # 应用程序类型
    type: "simple"
    # 主类名
    main_class: ""
    # 应用程序参数
    args: [ ]
    # 环境变量
    env: { }
```

### 环境变量

| 环境变量           | 默认值         | 描述                     |
|----------------|-------------|------------------------|
| `AM_HOST`      | `localhost` | ApplicationMaster 主机地址 |
| `AM_PORT`      | `8080`      | ApplicationMaster 端口   |
| `AM_HEAP_SIZE` | `512m`      | JVM 堆大小                |
| `RM_HOST`      | `localhost` | ResourceManager 主机地址   |
| `RM_PORT`      | `8088`      | ResourceManager 端口     |

## 📊 调度器配置

### FIFO 调度器

```yaml
scheduler:
    type: "fifo"
    config:
        # 用户限制
        user_limit_factor: 1.0
        # 最大应用程序数
        max_applications: 1000
```

### Capacity 调度器

```xml
<!-- configs/capacity-scheduler.xml -->
<configuration>
  <!-- 队列定义 -->
  <property>
    <name>yarn.scheduler.capacity.resource-calculator</name>
    <value>org.apache.hadoop.yarn.util.resource.DefaultResourceCalculator</value>
  </property>

  <property>
    <name>yarn.scheduler.capacity.root.queues</name>
    <value>default,development,production</value>
  </property>

  <!-- 默认队列 -->
  <property>
    <name>yarn.scheduler.capacity.root.default.capacity</name>
    <value>40</value>
  </property>

  <property>
    <name>yarn.scheduler.capacity.root.default.maximum-capacity</name>
    <value>60</value>
  </property>

  <property>
    <name>yarn.scheduler.capacity.root.default.user-limit-factor</name>
    <value>1</value>
  </property>

  <!-- 开发队列 -->
  <property>
    <name>yarn.scheduler.capacity.root.development.capacity</name>
    <value>20</value>
  </property>

  <property>
    <name>yarn.scheduler.capacity.root.development.maximum-capacity</name>
    <value>40</value>
  </property>

  <!-- 生产队列 -->
  <property>
    <name>yarn.scheduler.capacity.root.production.capacity</name>
    <value>40</value>
  </property>

  <property>
    <name>yarn.scheduler.capacity.root.production.maximum-capacity</name>
    <value>80</value>
  </property>
</configuration>
```

### Fair 调度器

```xml
<!-- configs/fair-scheduler.xml -->
<allocations>
  <!-- 默认队列设置 -->
  <queueMaxAMShareDefault>0.5</queueMaxAMShareDefault>
  <queueMaxResourcesDefault>40gb,10vcores</queueMaxResourcesDefault>

  <!-- 队列定义 -->
  <queue name="sample_queue">
    <minResources>10000mb,0vcores</minResources>
    <maxResources>90000mb,0vcores</maxResources>
    <maxRunningApps>50</maxRunningApps>
    <weight>2.0</weight>
    <schedulingPolicy>fair</schedulingPolicy>

    <queue name="sample_sub_queue">
      <aclSubmitApps>charlie</aclSubmitApps>
      <minResources>5000mb,0vcores</minResources>
    </queue>
  </queue>

  <!-- 用户设置 -->
  <user name="sample_user">
    <maxRunningApps>30</maxRunningApps>
  </user>

  <!-- 队列放置策略 -->
  <queuePlacementPolicy>
    <rule name="specified" />
    <rule name="primaryGroup" create="false" />
    <rule name="default" queue="sample_queue"/>
  </queuePlacementPolicy>
</allocations>
```

## 🔐 安全配置

### 认证配置

```yaml
security:
    # 认证配置
    authentication:
        # 认证类型: simple, jwt, kerberos
        type: "simple"

        # JWT 配置
        jwt:
            secret_key: "your-secret-key"
            expiration: "24h"
            issuer: "carrot-yarn"

        # Kerberos 配置
        kerberos:
            principal: "yarn/_HOST@REALM"
            keytab: "/etc/yarn.keytab"
            realm: "REALM"

    # 授权配置
    authorization:
        # 是否启用 ACL
        enabled: false

        # 管理员 ACL
        admin_acl:
            users: ["admin"]
            groups: ["admin"]

        # 队列 ACL
        queue_acl:
            default:
                submit_users: ["*"]
                submit_groups: ["*"]
                admin_users: ["admin"]
                admin_groups: ["admin"]

    # TLS 配置
    tls:
        # 是否启用 TLS
        enabled: false

        # 证书配置
        cert_file: "/etc/ssl/certs/yarn.crt"
        key_file: "/etc/ssl/private/yarn.key"
        ca_file: "/etc/ssl/certs/ca.crt"

        # 密码套件
        cipher_suites: []

        # 最小 TLS 版本
        min_version: "1.2"
```

### 访问控制

```yaml
acl:
    # 应用程序提交 ACL
    submit_application:
        users: ["user1", "user2"]
        groups: ["group1", "group2"]

    # 应用程序管理 ACL
    admin_application:
        users: ["admin"]
        groups: ["admin"]

    # 集群管理 ACL
    admin_cluster:
        users: ["admin"]
        groups: ["admin"]

    # 队列管理 ACL
    admin_queue:
        users: ["admin"]
        groups: ["admin"]
```

## 📈 监控配置

### Prometheus 配置

```yaml
monitoring:
    # Prometheus 配置
    prometheus:
        # 是否启用
        enabled: true

        # 监听地址
        host: "0.0.0.0"
        port: 9090

        # 指标路径
        metrics_path: "/metrics"

        # 采集间隔
        scrape_interval: "15s"

        # 指标保留时间
        retention: "15d"

    # Grafana 配置
    grafana:
        # 是否启用
        enabled: true

        # 监听地址
        host: "0.0.0.0"
        port: 3000

        # 数据源配置
        datasource:
            url: "http://localhost:9090"
            type: "prometheus"

    # 日志配置
    logging:
        # 日志级别
        level: "info"

        # 日志格式: text, json
        format: "json"

        # 日志输出: stdout, file
        output: "stdout"

        # 日志文件
        file: "/var/log/carrot/app.log"

        # 日志轮转
        rotation:
            max_size: "100m"
            max_age: "7d"
            max_backups: 10
```

### 告警配置

```yaml
alerting:
  # 告警规则
  rules:
    - name: "cluster_health"
      rules:
        - alert: "NodeDown"
          expr: 'up{job="nodemanager"} == 0'
          for: "1m"
          labels:
            severity: "critical"
          annotations:
            summary: "NodeManager is down"

        - alert: "HighMemoryUsage"
          expr: "memory_usage_percent > 90"
          for: "5m"
          labels:
            severity: "warning"
          annotations:
            summary: "High memory usage detected"

  # 通知配置
  notifications:
    # 邮件通知
    email:
      enabled: false
      smtp_server: "smtp.example.com"
      smtp_port: 587
      username: "alerts@example.com"
      password: "password"

    # Slack 通知
    slack:
      enabled: false
      webhook_url: "https://hooks.slack.com/services/..."
      channel: "#alerts"
```

## 🌐 网络配置

### 端口配置

| 组件                | 默认端口 | 配置项                             | 描述          |
|-------------------|------|---------------------------------|-------------|
| ResourceManager   | 8088 | `resourcemanager.server.port`   | HTTP API 端口 |
| NodeManager       | 8042 | `nodemanager.server.port`       | HTTP API 端口 |
| ApplicationMaster | 8080 | `applicationmaster.server.port` | HTTP API 端口 |
| Prometheus        | 9090 | `monitoring.prometheus.port`    | 监控指标端口      |
| Grafana           | 3000 | `monitoring.grafana.port`       | 监控面板端口      |

### 负载均衡配置

```yaml
load_balancer:
  # 负载均衡器类型: nginx, haproxy, consul
  type: "nginx"

  # 健康检查
  health_check:
    enabled: true
    path: "/health"
    interval: "30s"
    timeout: "5s"

  # 上游服务器
  upstream:
    resourcemanager:
      - "rm1.example.com:8088"
      - "rm2.example.com:8088"

    nodemanager:
      - "nm1.example.com:8042"
      - "nm2.example.com:8042"
```

## 🔧 环境变量

### 通用环境变量

| 变量名                | 默认值                 | 描述          |
|--------------------|---------------------|-------------|
| `CARROT_HOME`      | `/opt/carrot`       | Carrot 安装目录 |
| `CARROT_CONF_DIR`  | `$CARROT_HOME/conf` | 配置文件目录      |
| `CARROT_LOG_DIR`   | `$CARROT_HOME/logs` | 日志文件目录      |
| `CARROT_PID_DIR`   | `/var/run/carrot`   | PID 文件目录    |
| `CARROT_HEAP_SIZE` | `1024m`             | JVM 堆大小     |
| `CARROT_OPTS`      | `""`                | 额外的 JVM 参数  |

### 组件特定环境变量

#### ResourceManager

| 变量名            | 默认值         | 描述                  |
|----------------|-------------|---------------------|
| `RM_HEAP_SIZE` | `2048m`     | ResourceManager 堆大小 |
| `RM_HOST`      | `localhost` | ResourceManager 主机  |
| `RM_PORT`      | `8088`      | ResourceManager 端口  |

#### NodeManager

| 变量名            | 默认值     | 描述              |
|----------------|---------|-----------------|
| `NM_HEAP_SIZE` | `1024m` | NodeManager 堆大小 |
| `NM_MEMORY`    | `8192`  | 节点内存 (MB)       |
| `NM_VCORES`    | `8`     | 节点 CPU 核心数      |

#### ApplicationMaster

| 变量名            | 默认值    | 描述                    |
|----------------|--------|-----------------------|
| `AM_HEAP_SIZE` | `512m` | ApplicationMaster 堆大小 |
| `AM_MEMORY`    | `1024` | AM 容器内存 (MB)          |
| `AM_VCORES`    | `1`    | AM 容器 CPU 核心数         |

## 📝 配置示例

### 单节点开发环境

```yaml
# config.yaml
cluster:
  name: "dev-cluster"

resourcemanager:
  server:
    host: "localhost"
    port: 8088
  scheduler:
    type: "fifo"
  recovery:
    enabled: false

nodemanager:
  server:
    host: "localhost"
    port: 8042
  resourcemanager:
    host: "localhost"
    port: 8088
  resources:
    memory: 4096
    vcores: 4

monitoring:
  prometheus:
    enabled: true
    port: 9090
```

### 多节点生产环境

```yaml
# config.yaml
cluster:
  name: "prod-cluster"

resourcemanager:
  server:
    host: "0.0.0.0"
    port: 8088
    tls:
      enabled: true
      cert_file: "/etc/ssl/certs/rm.crt"
      key_file: "/etc/ssl/private/rm.key"

  scheduler:
    type: "capacity"
    config_file: "configs/capacity-scheduler.xml"

  recovery:
    enabled: true
    store_type: "file"
    store_dir: "/data/rm-state"

  security:
    enabled: true
    auth_type: "jwt"

nodemanager:
  server:
    host: "0.0.0.0"
    port: 8042
    tls:
      enabled: true
      cert_file: "/etc/ssl/certs/nm.crt"
      key_file: "/etc/ssl/private/nm.key"

  resourcemanager:
    host: "rm.example.com"
    port: 8088

  resources:
    memory: 32768
    vcores: 16
    detect_hardware: true

  security:
    enabled: true
    check_user: true

monitoring:
  prometheus:
    enabled: true
    port: 9090
    retention: "30d"

  grafana:
    enabled: true
    port: 3000

alerting:
  rules:
    - name: "cluster_health"
      rules:
        - alert: "NodeDown"
          expr: 'up{job="nodemanager"} == 0'
          for: "1m"

  notifications:
    email:
      enabled: true
      smtp_server: "smtp.company.com"
      username: "alerts@company.com"
```

### Kubernetes 环境

```yaml
# k8s-config.yaml
cluster:
  name: "k8s-cluster"

resourcemanager:
  server:
    host: "0.0.0.0"
    port: 8088

  scheduler:
    type: "capacity"

  recovery:
    enabled: true
    store_type: "etcd"
    store_config:
      endpoints: [ "etcd:2379" ]

nodemanager:
  server:
    host: "0.0.0.0"
    port: 8042

  resourcemanager:
    host: "resourcemanager-service"
    port: 8088

  resources:
    detect_hardware: true

  containers:
    executor_type: "linux"

monitoring:
  prometheus:
    enabled: true
    port: 9090
```

## 🔍 配置验证

### 配置检查命令

```bash
# 验证配置文件语法
carrot config validate --config config.yaml

# 检查配置兼容性
carrot config check --config config.yaml

# 生成默认配置
carrot config generate --output default-config.yaml

# 配置差异比较
carrot config diff --config1 config1.yaml --config2 config2.yaml
```

### 配置模板

```bash
# 生成开发环境配置模板
carrot config template --env development

# 生成生产环境配置模板
carrot config template --env production

# 生成 Kubernetes 配置模板
carrot config template --env kubernetes
```

## 📚 相关文档

- [🏗️ 系统架构](./系统架构.md) - 系统架构设计
- [🔧 开发指南](./开发指南.md) - 开发环境配置
- [📖 核心概念](./核心概念.md) - 理解配置背景
- [📦 快速安装指南](./快速安装指南.md) - 部署配置
