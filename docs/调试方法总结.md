# Carrot YARN 项目调试方法总结

## 🎯 快速开始调试

### 1. 基本环境检查

```bash
# 检查 Go 版本
go version

# 检查项目编译
make build

# 运行基本测试
go test ./...
```

### 2. 单元测试调试

```bash
# 运行所有测试并显示详细输出
go test -v ./...

# 运行特定组件测试
go test -v ./internal/resourcemanager
go test -v ./internal/nodemanager

# 运行特定测试函数
go test -v ./internal/resourcemanager -run TestResourceManagerCreation

# 运行测试并生成覆盖率报告
go test -coverprofile=coverage.out ./...
go tool cover -html=coverage.out -o coverage.html
```

### 3. 性能调试

```bash
# 运行基准测试
go test -bench=. -benchmem ./internal/resourcemanager
go test -bench=. -benchmem ./internal/nodemanager

# 生成 CPU 性能分析
go test -bench=. -cpuprofile=cpu.prof ./internal/resourcemanager
go tool pprof cpu.prof

# 生成内存分析
go test -bench=. -memprofile=mem.prof ./internal/resourcemanager
go tool pprof mem.prof
```

### 4. 集成测试调试

```bash
# 运行集成测试
./scripts/integration-test.sh

# 启动调试环境
./scripts/debug.sh

# 性能分析
./scripts/performance-analysis.sh
```

## 🔧 IDE 调试配置

### VS Code 调试

1. 安装 Go 扩展
2. 使用项目中的 `.vscode/launch.json` 配置
3. 设置断点
4. 按 F5 开始调试

### GoLand/IntelliJ 调试

1. 打开项目
2. 右键点击 `main.go` 文件
3. 选择 "Debug 'go build main.go'"
4. 在 Run Configuration 中设置参数

## 🛠️ 命令行调试

### 使用 Delve 调试器

```bash
# 安装 Delve
go install github.com/go-delve/delve/cmd/dlv@latest

# 调试 ResourceManager
dlv debug cmd/resourcemanager/main.go -- -port 8088

# 调试 NodeManager
dlv debug cmd/nodemanager/main.go -- -port 8042 -host localhost -rm-url http://localhost:8088

# 连接到运行中的进程
dlv attach <PID>

# 远程调试
dlv --listen=:2345 --headless=true --api-version=2 debug cmd/resourcemanager/main.go
```

### Delve 调试命令

```
(dlv) break main.main                    # 在 main 函数设置断点
(dlv) break internal/resourcemanager.(*ResourceManager).Start  # 在方法设置断点
(dlv) continue                           # 继续执行
(dlv) next                              # 下一行
(dlv) step                              # 步入
(dlv) print variable_name               # 打印变量
(dlv) locals                            # 显示局部变量
(dlv) goroutines                        # 显示 goroutine
(dlv) stack                             # 显示调用栈
```

## 📊 日志调试

### 启用详细日志

```bash
# 设置环境变量
export LOG_LEVEL=DEBUG
export CARROT_DEBUG=true

# 启动服务
./bin/resourcemanager -port 8088
./bin/nodemanager -port 8042 -host localhost -rm-url http://localhost:8088
```

### 日志分析

```bash
# 实时查看日志
tail -f logs/*.log

# 搜索错误
grep -i error logs/*.log
grep -i "failed\|error\|panic" logs/*.log

# 按时间查看日志
ls -lt logs/ | head -10
```

## 🌐 网络调试

### HTTP API 调试

```bash
# 检查集群状态
curl -v http://localhost:8088/ws/v1/cluster/info

# 查看节点信息
curl -s http://localhost:8088/ws/v1/cluster/nodes | jq .

# 查看应用状态
curl -s http://localhost:8088/ws/v1/cluster/apps | jq .

# 测试应用提交
curl -X POST -H "Content-Type: application/json" \
     -d '{"application_name": "test", "commands": ["echo test"]}' \
     http://localhost:8088/ws/v1/cluster/apps
```

### 网络连接调试

```bash
# 检查端口占用
lsof -i :8088
lsof -i :8042
netstat -tlnp | grep -E '8088|8042'

# 测试网络连通性
telnet localhost 8088
nc -zv localhost 8088

# 网络抓包
sudo tcpdump -i lo -w debug.pcap port 8088
```

## 🔍 系统级调试

### 进程调试

```bash
# 查看进程状态
ps aux | grep -E 'resourcemanager|nodemanager'

# 查看进程树
pstree -p

# 系统调用跟踪
strace -o trace.log ./bin/resourcemanager -port 8088
```

### 资源监控

```bash
# CPU 和内存使用
top -p <PID>
htop

# 文件描述符
lsof -p <PID>

# 系统负载
uptime
vmstat 1
iostat 1
```

## 🚨 常见问题排查

### 1. 服务启动失败

```bash
# 检查端口占用
lsof -i :8088
sudo kill -9 $(lsof -ti:8088)

# 检查权限
ls -la /tmp/yarn-containers/
mkdir -p /tmp/yarn-containers
chmod 755 /tmp/yarn-containers

# 检查日志
tail -20 logs/resourcemanager.log
tail -20 logs/nodemanager.log
```

### 2. 节点注册失败

```bash
# 检查网络连接
curl http://localhost:8088/ws/v1/cluster/info

# 检查 NodeManager 配置
./bin/nodemanager -h

# 查看详细错误
export LOG_LEVEL=DEBUG
./bin/nodemanager -port 8042 -host localhost -rm-url http://localhost:8088
```

### 3. 应用提交失败

```bash
# 检查资源可用性
curl http://localhost:8088/ws/v1/cluster/nodes

# 检查应用状态
curl http://localhost:8088/ws/v1/cluster/apps

# 查看客户端日志
./bin/client -rm-url http://localhost:8088 -app-name "test" -command "echo test"
```

## 📈 性能优化调试

### CPU 性能分析

```bash
# 启用 CPU 分析
export GODEBUG=gctrace=1

# 使用 pprof
go tool pprof http://localhost:6060/debug/pprof/profile?seconds=30

# 分析结果
(pprof) top10
(pprof) web
(pprof) list function_name
```

### 内存分析

```bash
# 内存使用分析
go tool pprof http://localhost:6060/debug/pprof/heap

# 查看内存分配
go tool pprof http://localhost:6060/debug/pprof/allocs

# Goroutine 分析
go tool pprof http://localhost:6060/debug/pprof/goroutine
```

### 竞争条件检测

```bash
# 启用竞争检测
go build -race -o bin/resourcemanager cmd/resourcemanager/main.go
./bin/resourcemanager -port 8088

# 运行测试时检测竞争
go test -race ./...
```

## 🎛️ 高级调试技巧

### 1. 分布式追踪

```go
// 添加请求 ID 追踪
func addRequestID(next http.HandlerFunc) http.HandlerFunc {
    return func(w http.ResponseWriter, r *http.Request) {
        requestID := generateRequestID()
        ctx := context.WithValue(r.Context(), "requestID", requestID)
        next(w, r.WithContext(ctx))
    }
}
```

### 2. 结构化日志

```go
// 使用结构化日志
logger := log.WithFields(log.Fields{
"component": "resourcemanager",
"function": "SubmitApplication",
"appID": appID,
})
logger.Info("Application submitted successfully")
```

### 3. 健康检查端点

```go
// 添加健康检查
func (rm *ResourceManager) healthCheck(w http.ResponseWriter, r *http.Request) {
    status := map[string]interface{}{
        "status": "healthy",
        "uptime": time.Since(rm.startTime),
        "nodes": len(rm.nodes),
        "apps": len(rm.applications),
    }
    json.NewEncoder(w).Encode(status)
}
```

## 📚 调试最佳实践

1. **渐进式调试**: 从单元测试开始，逐步进行集成测试
2. **日志先行**: 在关键路径添加详细日志
3. **监控指标**: 收集关键性能指标
4. **自动化测试**: 使用 CI/CD 自动运行测试
5. **文档更新**: 及时更新调试文档和已知问题
