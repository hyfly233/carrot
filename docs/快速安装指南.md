# Carrot YARN 快速安装指南

本指南将帮助您快速搭建一个功能完整的 Carrot YARN 集群。

## 🚀 快速开始 (5 分钟)

### 前置要求

```bash
# 检查 Go 版本 (需要 1.24+)
go version

# 检查系统环境
uname -a

# 检查可用端口
netstat -tuln | grep -E ':(8088|8042|8080)'
```

### 一键安装脚本

```bash
# 下载并运行安装脚本
curl -fsSL https://raw.githubusercontent.com/hyfly233/carrot/main/scripts/install.sh | bash

# 或者手动下载
wget https://github.com/hyfly233/carrot/releases/latest/download/carrot-linux-amd64.tar.gz
tar -xzf carrot-linux-amd64.tar.gz
cd carrot
```

## 📦 安装方式

### 方式 1: 预编译二进制文件 (推荐)

#### Linux/macOS

```bash
# 下载最新版本
export CARROT_VERSION="v1.0.0"
export OS="linux"  # 或 "darwin" (macOS)
export ARCH="amd64"

wget https://github.com/hyfly233/carrot/releases/download/${CARROT_VERSION}/carrot-${OS}-${ARCH}.tar.gz

# 解压并安装
tar -xzf carrot-${OS}-${ARCH}.tar.gz
sudo mv carrot/bin/* /usr/local/bin/

# 验证安装
carrot-rm --version
carrot-nm --version
```

#### 使用安装脚本

```bash
# 自动检测系统并安装
curl -fsSL https://raw.githubusercontent.com/hyfly233/carrot/main/scripts/install.sh | bash

# 指定版本安装
curl -fsSL https://raw.githubusercontent.com/hyfly233/carrot/main/scripts/install.sh | bash -s -- --version v1.0.0

# 指定安装目录
curl -fsSL https://raw.githubusercontent.com/hyfly233/carrot/main/scripts/install.sh | bash -s -- --prefix /opt/carrot
```

### 方式 2: 源码编译

```bash
# 克隆仓库
git clone https://github.com/hyfly233/carrot.git
cd carrot

# 编译所有组件
make build

# 或者分别编译
make build-rm    # ResourceManager
make build-nm    # NodeManager
make build-am    # ApplicationMaster
make build-client # Client

# 安装到系统路径
sudo make install
```

### 方式 3: Docker 部署

```bash
# 拉取官方镜像
docker pull carrot/resourcemanager:latest
docker pull carrot/nodemanager:latest

# 使用 Docker Compose
wget https://raw.githubusercontent.com/hyfly233/carrot/main/deployments/docker/docker-compose.yml
docker-compose up -d

# 验证部署
docker-compose ps
```

### 方式 4: Helm 部署 (Kubernetes)

```bash
# 添加 Helm 仓库
helm repo add carrot https://charts.carrot.io
helm repo update

# 安装 Carrot 集群
helm install my-carrot carrot/carrot \
  --set resourcemanager.replicas=2 \
  --set nodemanager.replicas=3

# 查看安装状态
kubectl get pods -l app.kubernetes.io/name=carrot
```

## ⚙️ 基础配置

### 创建配置文件

```bash
# 创建配置目录
sudo mkdir -p /etc/carrot
sudo mkdir -p /var/log/carrot
sudo mkdir -p /var/lib/carrot

# 生成默认配置
carrot-rm --generate-config > /etc/carrot/resourcemanager.yaml
carrot-nm --generate-config > /etc/carrot/nodemanager.yaml
```

### ResourceManager 配置

```yaml
# /etc/carrot/resourcemanager.yaml
resourcemanager:
    # 服务配置
    port: 8088
    bind_address: "0.0.0.0"

    # 调度器配置
    scheduler:
        type: "capacity" # 支持: fifo, capacity, fair
        capacity:
            queues:
                - name: "default"
                  capacity: 50
                  max_capacity: 80
                - name: "high"
                  capacity: 30
                  max_capacity: 100
                - name: "low"
                  capacity: 20
                  max_capacity: 50

    # 资源配置
    resources:
        minimum_allocation:
            memory: 512 # MB
            cpu: 0.5 # vCores
        maximum_allocation:
            memory: 8192 # MB
            cpu: 8 # vCores

    # 安全配置
    security:
        enabled: false
        auth_type: "simple" # 支持: simple, kerberos, jwt

    # 监控配置
    metrics:
        enabled: true
        port: 9090
        path: "/metrics"
```

### NodeManager 配置

```yaml
# /etc/carrot/nodemanager.yaml
nodemanager:
    # 服务配置
    port: 8042
    bind_address: "0.0.0.0"

    # ResourceManager 连接
    resourcemanager:
        url: "http://localhost:8088"
        heartbeat_interval: "3s"

    # 资源配置
    resources:
        memory: 8192 # MB
        cpu: 4 # vCores
        disk: 102400 # MB

    # 容器配置
    containers:
        executor: "process" # 支持: process, docker
        isolation: "process" # 支持: process, cgroups
        log_retention: "7d"
        max_containers: 100

    # 本地化配置
    localizer:
        cache_size: 10240 # MB
        cleanup_interval: "1h"

    # 监控配置
    monitoring:
        enabled: true
        interval: "10s"
        metrics_port: 9091
```

## 🏁 启动集群

### 方式 1: 手动启动

```bash
# 1. 启动 ResourceManager
carrot-rm --config /etc/carrot/resourcemanager.yaml &

# 2. 等待 ResourceManager 启动
sleep 5

# 3. 启动 NodeManager
carrot-nm --config /etc/carrot/nodemanager.yaml &

# 4. 验证集群状态
carrot-client cluster-info
```

### 方式 2: systemd 服务

```bash
# 创建 systemd 服务文件
sudo tee /etc/systemd/system/carrot-rm.service > /dev/null <<EOF
[Unit]
Description=Carrot ResourceManager
After=network.target

[Service]
Type=simple
User=carrot
Group=carrot
ExecStart=/usr/local/bin/carrot-rm --config /etc/carrot/resourcemanager.yaml
Restart=always
RestartSec=5
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
EOF

sudo tee /etc/systemd/system/carrot-nm.service > /dev/null <<EOF
[Unit]
Description=Carrot NodeManager
After=network.target carrot-rm.service

[Service]
Type=simple
User=carrot
Group=carrot
ExecStart=/usr/local/bin/carrot-nm --config /etc/carrot/nodemanager.yaml
Restart=always
RestartSec=5
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
EOF

# 启动服务
sudo systemctl daemon-reload
sudo systemctl enable carrot-rm carrot-nm
sudo systemctl start carrot-rm
sudo systemctl start carrot-nm

# 检查状态
sudo systemctl status carrot-rm carrot-nm
```

### 方式 3: Docker Compose

```yaml
# docker-compose.yml
version: "3.8"
services:
    resourcemanager:
        image: carrot/resourcemanager:latest
        ports:
            - "8088:8088"
            - "9090:9090" # metrics
        environment:
            - RM_PORT=8088
            - RM_SCHEDULER=capacity
        volumes:
            - ./config/rm.yaml:/etc/carrot/resourcemanager.yaml
            - rm_data:/var/lib/carrot
        restart: unless-stopped

    nodemanager1:
        image: carrot/nodemanager:latest
        ports:
            - "8042:8042"
            - "9091:9091" # metrics
        environment:
            - NM_PORT=8042
            - NM_RM_URL=http://resourcemanager:8088
            - NM_MEMORY=4096
            - NM_VCORES=2
        volumes:
            - ./config/nm.yaml:/etc/carrot/nodemanager.yaml
            - nm1_data:/var/lib/carrot
        depends_on:
            - resourcemanager
        restart: unless-stopped

    nodemanager2:
        image: carrot/nodemanager:latest
        ports:
            - "8043:8042"
            - "9092:9091" # metrics
        environment:
            - NM_PORT=8042
            - NM_RM_URL=http://resourcemanager:8088
            - NM_MEMORY=4096
            - NM_VCORES=2
        volumes:
            - ./config/nm.yaml:/etc/carrot/nodemanager.yaml
            - nm2_data:/var/lib/carrot
        depends_on:
            - resourcemanager
        restart: unless-stopped

volumes:
    rm_data:
    nm1_data:
    nm2_data:
```

```bash
# 启动集群
docker-compose up -d

# 查看日志
docker-compose logs -f

# 停止集群
docker-compose down
```

## ✅ 验证安装

### 1. 检查服务状态

```bash
# 检查进程
ps aux | grep carrot

# 检查端口
netstat -tuln | grep -E ':(8088|8042)'

# 检查日志
tail -f /var/log/carrot/resourcemanager.log
tail -f /var/log/carrot/nodemanager.log
```

### 2. 使用 REST API

```bash
# 检查 ResourceManager 状态
curl http://localhost:8088/ws/v1/cluster/info

# 检查节点信息
curl http://localhost:8088/ws/v1/cluster/nodes

# 检查应用程序
curl http://localhost:8088/ws/v1/cluster/apps
```

### 3. 使用客户端工具

```bash
# 查看集群信息
carrot-client cluster-info

# 查看节点列表
carrot-client node list

# 查看队列信息
carrot-client queue list
```

### 4. 提交测试应用

```bash
# 提交简单测试应用
carrot-client app submit \
  --name "test-app" \
  --memory 1024 \
  --vcores 1 \
  --command "sleep 60"

# 查看应用状态
carrot-client app list

# 查看应用详情
carrot-client app status <app-id>
```

## 🌐 Web 界面

### 访问 Web UI

```bash
# ResourceManager Web UI
open http://localhost:8088

# NodeManager Web UI
open http://localhost:8042

# 监控面板 (如果启用)
open http://localhost:9090  # ResourceManager 指标
open http://localhost:9091  # NodeManager 指标
```

### Web UI 功能

-   **集群概览**: 资源使用情况和节点状态
-   **应用程序管理**: 应用列表、状态和详情
-   **资源监控**: 实时资源使用图表
-   **日志查看**: 应用和容器日志
-   **配置管理**: 集群配置查看和修改

## 🔧 故障排查

### 常见问题

#### 1. ResourceManager 启动失败

```bash
# 检查端口占用
sudo lsof -i :8088

# 检查配置文件
carrot-rm --config /etc/carrot/resourcemanager.yaml --validate

# 查看详细日志
carrot-rm --config /etc/carrot/resourcemanager.yaml --log-level debug
```

#### 2. NodeManager 无法连接 ResourceManager

```bash
# 检查网络连通性
curl http://localhost:8088/ws/v1/cluster/info

# 检查 NodeManager 配置
grep resourcemanager /etc/carrot/nodemanager.yaml

# 检查防火墙
sudo ufw status
sudo iptables -L
```

#### 3. 应用提交失败

```bash
# 检查资源是否足够
carrot-client cluster-info

# 检查队列配置
carrot-client queue list

# 查看详细错误
carrot-client app submit --name test --memory 1024 --vcores 1 --verbose
```

### 日志配置

```yaml
# 在配置文件中添加日志配置
logging:
    level: "info" # debug, info, warn, error
    format: "json" # json, text
    output: "/var/log/carrot/resourcemanager.log"
    max_size: 100 # MB
    max_backups: 5
    max_age: 30 # days
```

### 调试模式

```bash
# 启用调试模式
export CARROT_DEBUG=true
export CARROT_LOG_LEVEL=debug

# 启动组件
carrot-rm --config /etc/carrot/resourcemanager.yaml
```

## 📈 性能调优

### 初始调优建议

```yaml
# ResourceManager 调优
resourcemanager:
    # 提高并发处理能力
    max_concurrent_apps: 1000
    heartbeat_interval: "3s"

    # 调度器优化
    scheduler:
        max_pending_requests: 1000
        allocation_timeout: "10s"

# NodeManager 调优
nodemanager:
    # 提高容器密度
    containers:
        max_containers: 200
        memory_overhead: 384 # MB

    # 监控优化
    monitoring:
        interval: "5s"
        batch_size: 100
```

## 🔄 升级指南

### 滚动升级

```bash
# 1. 升级 NodeManager (逐个节点)
sudo systemctl stop carrot-nm
sudo cp new-carrot-nm /usr/local/bin/carrot-nm
sudo systemctl start carrot-nm

# 2. 升级 ResourceManager (高可用模式)
sudo systemctl stop carrot-rm-standby
sudo cp new-carrot-rm /usr/local/bin/carrot-rm
sudo systemctl start carrot-rm-standby
# 切换主备...
```

## 📚 下一步

安装完成后，您可以：

1. 📖 阅读 [基础使用教程](./基础使用教程.md)
2. 🏗️ 了解 [系统架构](./系统架构.md)
3. ⚙️ 查看 [配置参考](./配置参考.md)
4. 🔧 学习 [调试指南](./调试指南.md)
5. 📊 配置 [监控告警](./监控告警.md)
