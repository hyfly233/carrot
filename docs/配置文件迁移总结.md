# Carrot YARN 配置文件迁移完成

## 概述

已成功将 Carrot YARN 项目从命令行参数启动改为配置文件启动。这一改进提供了更好的配置管理、更清晰的部署方式以及更强的可维护性。

## 主要改进

### 1. 配置文件系统

- **新增配置加载器**: `LoadConfig()` 和 `LoadConfigFromDir()` 函数
- **YAML 配置解析**: 支持完整的 YAML 配置文件格式
- **环境变量支持**: 敏感信息可通过环境变量提供
- **默认配置兜底**: 配置文件不存在时自动使用默认配置

### 2. 组件专用配置

- **ResourceManager**: `configs/resourcemanager.yaml`
- **NodeManager**: `configs/nodemanager.yaml`
- **ApplicationMaster**: `configs/applicationmaster.yaml`

### 3. 启动方式改进

#### 改进前（命令行参数）：

```bash
# 复杂的命令行参数
./bin/resourcemanager -port=8088 -dev=false
./bin/nodemanager -host=localhost -port=8042 -rm-url=http://localhost:8088 -memory=8192 -vcores=8 -dev=false
./bin/applicationmaster -rm_address=http://localhost:8030 -port=8088 -app_type=simple -num_tasks=3 -max_retries=3
```

#### 改进后（配置文件）：

```bash
# 简洁清晰的启动方式
./bin/resourcemanager -config=configs/resourcemanager.yaml
./bin/nodemanager -config=configs/nodemanager.yaml
./bin/applicationmaster -config=configs/applicationmaster.yaml -application_id=APP_ID -application_attempt_id=ATTEMPT_ID
```

### 4. 便捷脚本

#### 新增启动脚本：

- `scripts/start-resourcemanager.sh`
- `scripts/start-nodemanager.sh`
- `scripts/start-applicationmaster.sh`
- `scripts/start-cluster.sh` (已更新为配置文件模式)

#### 测试脚本：

- `scripts/test-config.sh` - 验证配置文件加载功能

## 配置文件示例

### ResourceManager 配置 (configs/resourcemanager.yaml)

```yaml
cluster:
  name: "carrot-cluster"
  id: "rm-1"
  discovery_method: "static"

resourcemanager:
  port: 8088
  address: "0.0.0.0"
  heartbeat_interval: 3s
  node_expiry_timeout: 600s
  application_max_attempts: 2

scheduler:
  type: "fifo"
  max_apps: 10000
```

### NodeManager 配置 (configs/nodemanager.yaml)

```yaml
cluster:
  name: "carrot-cluster"
  id: "nm-1"

nodemanager:
  port: 8042
  address: "0.0.0.0"
  resourcemanager_url: "http://localhost:8088"
  heartbeat_interval: 3s
  container_memory_limit_mb: 8192
  container_vcores_limit: 8
```

### ApplicationMaster 配置 (configs/applicationmaster.yaml)

```yaml
cluster:
  name: "carrot-cluster"
  id: "am-1"

applicationmaster:
  port: 8088
  address: "0.0.0.0"
  resourcemanager_url: "http://localhost:8030"
  heartbeat_interval: 10s
  max_retries: 3
  app_type: "simple"
  num_tasks: 3
  num_workers: 2
```

## 技术实现

### 1. 配置结构扩展

- 扩展了 `Config` 结构体，新增 `ApplicationMasterConfig`
- 所有组件配置统一在 `internal/common/config.go`
- 支持嵌套配置和复杂数据类型

### 2. 配置加载机制

```go
// 配置文件加载
config, err := common.LoadConfig("configs/resourcemanager.yaml")

// 目录+文件名加载  
config, err := common.LoadConfigFromDir("configs", "resourcemanager.yaml")

// 配置保存
err := common.SaveConfig(config, "configs/resourcemanager.yaml")
```

### 3. 向后兼容性

- 保留了 `-dev` 开发模式参数
- ApplicationMaster 仍需要必要的运行时参数（app_id, attempt_id）
- 配置文件不存在时自动使用默认配置

## 验证结果

### ✅ 编译测试

```bash
go build ./...  # 成功编译所有组件
```

### ✅ 功能测试

```bash
go test ./...   # 所有测试通过
```

### ✅ 配置文件加载测试

```bash
./scripts/test-config.sh  # 所有组件成功加载配置文件
```

### ✅ 启动测试

所有组件都能成功：

- 加载配置文件
- 解析配置参数
- 初始化集群管理器
- 启动核心服务

## 使用方法

### 1. 快速启动

```bash
# 启动完整集群
./scripts/start-cluster.sh

# 单独启动组件
./scripts/start-resourcemanager.sh
./scripts/start-nodemanager.sh
```

### 2. 自定义配置

```bash
# 复制配置文件模板
cp configs/resourcemanager.yaml configs/resourcemanager-prod.yaml

# 编辑配置
vim configs/resourcemanager-prod.yaml

# 使用自定义配置启动
./bin/resourcemanager -config=configs/resourcemanager-prod.yaml
```

### 3. 开发模式

```bash
# 启用详细日志
./bin/resourcemanager -config=configs/resourcemanager.yaml -dev=true
```

## 优势总结

1. **配置管理**: 复杂配置结构化存储，易于版本控制
2. **部署简化**: 减少命令行参数，降低部署错误
3. **环境隔离**: 不同环境使用不同配置文件
4. **可维护性**: 配置修改无需重新编译
5. **文档化**: 配置文件本身就是文档
6. **集群支持**: 配置文件天然支持集群参数设置

## 迁移完成

✅ ResourceManager 配置文件化完成  
✅ NodeManager 配置文件化完成  
✅ ApplicationMaster 配置文件化完成  
✅ 启动脚本更新完成  
✅ 向后兼容性保证  
✅ 测试验证通过  
✅ 文档更新完成

项目现在可以完全通过配置文件管理和启动，大大提升了系统的可配置性和可维护性。
