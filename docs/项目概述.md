# Carrot YARN 项目概述

## 🎯 项目简介

Carrot 是一个使用 Go 语言完全重新实现的 Hadoop YARN (Yet Another Resource Negotiator) 集群资源管理系统。它提供了现代化、高性能、易于维护的
YARN 核心功能，包括资源管理、任务调度和容器管理。

### 🌟 为什么选择 Carrot？

| 特性       | 传统 YARN     | Carrot           |
|----------|-------------|------------------|
| **语言**   | Java        | Go               |
| **性能**   | JVM 开销      | 原生编译，更高效         |
| **内存使用** | 高内存占用       | 更低的内存占用          |
| **部署**   | 复杂 JVM 配置   | 单一二进制文件          |
| **监控**   | JMX + 第三方工具 | 内置 Prometheus 指标 |
| **容器化**  | 复杂配置        | 原生云支持            |

## 🏗️ 系统架构

### 核心组件

```
┌─────────────────────────────────────────────────────────────┐
│                        Carrot YARN 集群                        │
├─────────────────────────────────────────────────────────────┤
│  Client Layer                                              │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │ yarn client │  │   Web UI    │  │  REST API   │          │
│  └─────────────┘  └─────────────┘  └─────────────┘          │
├─────────────────────────────────────────────────────────────┤
│  ResourceManager Layer                                     │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │                  ResourceManager                        │ │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐       │ │
│  │  │ApplicationMgr│ │NodeManager │ │  Scheduler  │       │ │
│  │  └─────────────┘ └─────────────┘ └─────────────┘       │ │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐       │ │
│  │  │  Security   │ │  Recovery   │ │   Metrics   │       │ │
│  │  └─────────────┘ └─────────────┘ └─────────────┘       │ │
│  └─────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│  NodeManager Layer                                         │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │
│  │NodeManager 1│ │NodeManager 2│ │NodeManager N│           │
│  │┌───────────┐│ │┌───────────┐│ │┌───────────┐│           │
│  ││Container  ││ ││Container  ││ ││Container  ││           │
│  ││Manager    ││ ││Manager    ││ ││Manager    ││           │
│  │└───────────┘│ │└───────────┘│ │└───────────┘│           │
│  │┌───────────┐│ │┌───────────┐│ │┌───────────┐│           │
│  ││Resource   ││ ││Resource   ││ ││Resource   ││           │
│  ││Monitor    ││ ││Monitor    ││ ││Monitor    ││           │
│  │└───────────┘│ │└───────────┘│ │└───────────┘│           │
│  └─────────────┘ └─────────────┘ └─────────────┘           │
├─────────────────────────────────────────────────────────────┤
│  Application Layer                                         │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │
│  │ApplicationMaster1│ │ApplicationMaster2│ │ApplicationMasterN│       │
│  └─────────────┘ └─────────────┘ └─────────────┘           │
└─────────────────────────────────────────────────────────────┘
```

### 数据流

1. **应用提交流程**

    ```
    Client → ResourceManager → Scheduler → NodeManager → Container
    ```

2. **资源分配流程**

    ```
    ApplicationMaster → ResourceManager → NodeManager → Container
    ```

3. **心跳和状态流程**
    ```
    NodeManager → ResourceManager ← ApplicationMaster
    ```

## 🚀 核心功能

### 1. 资源管理

#### 多维度资源支持

- **CPU 资源**: 支持小数核心分配 (如 0.5 CPU)
- **内存资源**: 精确的内存分配和限制
- **自定义资源**: 扩展的资源类型支持 (GPU、存储等)
- **资源隔离**: 基于 cgroups 的资源隔离

#### 动态资源调整

```go
// 支持运行时资源调整
spec := &common.ResourceSpec{
    CPU:         2.0,
    Memory:      4096,
    CPULimit:    4.0,
    MemoryLimit: 8192,
}
```

### 2. 任务调度

#### 调度策略

- **FIFO 调度器**: 简单的先进先出调度
- **Capacity 调度器**: 基于队列容量的调度
- **Fair 调度器**: 公平共享调度
- **自定义调度器**: 可插拔的调度器框架

#### 调度特性

- **优先级调度**: 应用程序和任务优先级
- **抢占机制**: 高优先级任务抢占低优先级资源
- **放置约束**: 节点选择和亲和性配置
- **资源预留**: 防止资源碎片化

### 3. 容器管理

#### 容器生命周期

```go
type ContainerState string

const (
    ContainerStateNew       ContainerState = "NEW"
    ContainerStateRunning   ContainerState = "RUNNING"
    ContainerStateComplete  ContainerState = "COMPLETE"
    ContainerStateFailed    ContainerState = "FAILED"
)
```

#### 容器特性

- **进程隔离**: 基于操作系统进程的隔离
- **资源限制**: CPU 和内存使用限制
- **环境管理**: 环境变量和工作目录设置
- **日志收集**: 标准输出和错误输出收集

### 4. 应用程序管理

#### 应用程序类型

1. **简单应用程序**: 独立任务执行
2. **分布式应用程序**: 主从架构应用
3. **服务应用程序**: 长期运行的服务

#### 应用程序生命周期

```
NEW → SUBMITTED → ACCEPTED → RUNNING → FINISHED/FAILED/KILLED
```

## 📊 性能特性

### 吞吐量

- **应用程序提交**: > 1000 apps/sec
- **容器分配**: > 10000 containers/sec
- **心跳处理**: > 100000 heartbeats/sec

### 可扩展性

- **节点数量**: 支持 10000+ 节点
- **并发应用**: 支持 100000+ 应用程序
- **容器密度**: 单节点 1000+ 容器

### 资源效率

- **内存占用**: < 100MB (ResourceManager)
- **CPU 开销**: < 5% (NodeManager)
- **启动时间**: < 5s (所有组件)

## 🔒 安全特性

### 认证和授权

- **Token 认证**: 基于 JWT 的认证机制
- **ACL 控制**: 细粒度的访问控制
- **安全通信**: TLS 加密通信

### 容器安全

- **用户隔离**: 多用户环境支持
- **资源隔离**: 防止资源泄露
- **权限控制**: 最小权限原则

## 🌐 云原生支持

### 容器化部署

```dockerfile
FROM golang:1.21-alpine AS builder
WORKDIR /app
COPY . .
RUN go build -o carrot-rm cmd/resourcemanager/main.go

FROM alpine:latest
RUN apk --no-cache add ca-certificates
COPY --from=builder /app/carrot-rm /usr/local/bin/
ENTRYPOINT ["carrot-rm"]
```

### Kubernetes 集成

- **Helm Charts**: 官方 Helm 部署支持
- **Operator**: Kubernetes Operator 管理
- **Service Mesh**: Istio 集成支持

## 📈 监控和可观测性

### 指标系统

- **Prometheus 指标**: 内置指标导出
- **Grafana 仪表板**: 预配置监控面板
- **自定义指标**: 应用程序自定义指标

### 日志系统

- **结构化日志**: JSON 格式日志
- **日志级别**: 动态日志级别调整
- **分布式追踪**: Jaeger 集成

### 告警系统

- **规则配置**: 灵活的告警规则
- **多渠道通知**: 邮件、Slack、企业微信
- **故障自愈**: 自动故障恢复机制

## 🔧 配置管理

### 配置方式

1. **配置文件**: YAML/JSON 配置文件
2. **环境变量**: 12-Factor 应用支持
3. **命令行参数**: 启动参数配置
4. **动态配置**: 运行时配置更新

### 配置示例

```yaml
resourcemanager:
  port: 8088
  scheduler:
    type: "capacity"
    capacity:
      queues:
        - name: "default"
          capacity: 50
        - name: "high-priority"
          capacity: 30
        - name: "low-priority"
          capacity: 20
```

## 🚀 快速开始

### 最小化部署

```bash
# 1. 编译项目
make build

# 2. 启动 ResourceManager
./bin/resourcemanager --port 8088

# 3. 启动 NodeManager
./bin/node --rm-url http://localhost:8088 --port 8042

# 4. 提交应用
./bin/client submit-app --rm-url http://localhost:8088 \
  --app-name "test-app" --memory 1024 --vcores 1
```

### Docker 部署

```bash
# 拉取镜像
docker pull carrot/resourcemanager:latest
docker pull carrot/node:latest

# 启动集群
docker-compose up -d
```

## 📚 学习路径

### 🟢 初学者路径

1. [快速安装指南](./快速安装指南.md) - 搭建第一个集群
2. [基础使用教程](./基础使用教程.md) - 提交第一个应用
3. [核心概念](./核心概念.md) - 理解 YARN 概念

### 🟡 进阶路径

1. [系统架构](./系统架构.md) - 深入理解架构
2. [配置参考](./配置参考.md) - 掌握配置技巧
3. [性能调优](./性能调优.md) - 优化集群性能

### 🔴 专家路径

1. [源码分析](./源码分析.md) - 深入源码实现
2. [扩展开发](./扩展开发.md) - 开发自定义组件
3. [贡献指南](./贡献指南.md) - 参与项目开发
